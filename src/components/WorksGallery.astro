---
import type { ImageMetadata } from 'astro'
import type { Language } from '@/i18n/config'
import type { Post } from '@/types'
import { getPostPath } from '@/i18n/path'

interface Props {
  posts: Post[]
  lang: Language
}

const { posts, lang } = Astro.props

// 动态导入 src/content/posts/_images 目录下的所有图片
const imagesGlob = import.meta.glob<{ default: ImageMetadata }>(
  '/src/content/posts/_images/**/*.{jpeg,jpg,png,gif,webp}',
  { eager: true },
)

// 提取文章的第一张图片
async function getThumbnail(post: Post): Promise<{ type: 'image', src: string } | null> {
  const content = post.body || ''

  // 检查是否有第一张图片
  const imageMatch = content.match(/!\[.*?\]\((.*?\.(?:webp|jpg|jpeg|png|gif))\)/)
  if (imageMatch) {
    const imagePath = imageMatch[1]

    // 处理相对路径，转换为绝对路径
    if (imagePath.startsWith('./_images/') || imagePath.startsWith('../_images/')) {
      // 解码URL编码的字符（如%20）
      const decodedPath = decodeURIComponent(imagePath)
      const imageName = decodedPath.replace(/^\.\.?\/_images\//, '')
      const absolutePath = `/src/content/posts/_images/${imageName}`

      // 查找对应的图片模块
      const imageImporter = imagesGlob[absolutePath]
      if (imageImporter) {
        const imageMetadata = imageImporter.default
        // 直接返回图片路径，Astro会自动处理优化
        return { type: 'image', src: imageMetadata.src }
      }
    }

    // 如果是外部链接，直接使用
    if (imagePath.startsWith('http')) {
      return { type: 'image', src: imagePath }
    }

    // 其他情况返回原路径
    return { type: 'image', src: imagePath }
  }

  return null
}

// 获取文章描述
function getDescription(post: Post): string {
  return post.data.description || '暂无描述'
}

// 获取所有分类标签
function getCategories(posts: Post[]): string[] {
  const categories = new Set<string>()
  posts.forEach((post) => {
    if (post.data.tags && post.data.tags.length > 0) {
      post.data.tags.forEach(tag => categories.add(tag))
    }
  })
  return Array.from(categories).sort()
}
---

<div class="works-gallery">
  <!-- 分类标签 -->
  <div class="category-tags">
    <div class="no-heti flex flex-wrap gap-x-3 gap-y-3.2">
      <button
        class="category-tag active"
        data-category="all"
      >
        <span class="category-text">{lang === 'zh' ? '全部' : lang === 'zh-tw' ? '全部' : 'All'}</span>
      </button>
      {getCategories(posts).map(category => (
        <button
          class="category-tag"
          data-category={category}
        >
          <span class="category-text">{category}</span>
        </button>
      ))}
    </div>
  </div>

  <!-- 相册列表 -->
  <div class="album-list">
    {await Promise.all(posts.map(async (post, index) => {
      const slug = post.data.abbrlink || post.id
      const thumbnail = await getThumbnail(post)
      const description = getDescription(post)
      const postCategories = post.data.tags || []

      return (
        <div
          class="album-item"
          data-categories={postCategories.join(',')}
        >
          <a
            href={getPostPath(slug, lang)}
            class="album-link"
            transition:name={`post-${slug}${lang ? `-${lang}` : ''}`}
            data-disable-theme-toggle-transition
          >
            <div class="album-content">
              <!-- 左侧：文章信息 -->
              <div class="album-info">
                <h3 class="album-title">{post.data.title}</h3>
                <p class="album-description">{description}</p>
                <div class="album-meta">
                  <span class="album-date">
                    {post.data.published.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US')}
                  </span>
                  {postCategories.length > 0 && (
                    <span class="album-category">
                      {postCategories[0]}
                    </span>
                  )}
                </div>
              </div>

              <!-- 右侧：缩略图 -->
              <div class="album-thumbnail">
                {thumbnail
? (
                    <img
                      src={thumbnail.src}
                      alt={post.data.title}
                      loading="lazy"
                      class="thumbnail-image"
                    />
                )
: (
                  <div class="thumbnail-placeholder">
                    <span class="placeholder-text">暂无图片</span>
                  </div>
                )}
              </div>
            </div>
          </a>

          <!-- 分割线（除了最后一项） -->
          {index < posts.length - 1 && <div class="album-divider"></div>}
        </div>
      )
    }))}
  </div>

  <!-- 分类筛选脚本 -->
  <script>
document.addEventListener('DOMContentLoaded', () => {
  const categoryTags = document.querySelectorAll('.category-tag')
  const albumItems = document.querySelectorAll('.album-item')

  categoryTags.forEach((tag) => {
    tag.addEventListener('click', (event) => {
      const target = event.target as HTMLElement

      // 移除所有标签的激活状态
      categoryTags.forEach(t => t.classList.remove('active'))
      // 添加当前标签的激活状态
      target.classList.add('active')

      const selectedCategory = target.dataset.category || 'all'

      // 筛选作品
      albumItems.forEach((item) => {
        const itemElement = item as HTMLElement
        if (selectedCategory === 'all') {
          itemElement.style.display = 'block'
        }
        else {
          const categories = itemElement.dataset.categories?.split(',') || []
          if (categories.includes(selectedCategory)) {
            itemElement.style.display = 'block'
          }
          else {
            itemElement.style.display = 'none'
          }
        }
      })

      // 重新显示分割线
      setTimeout(() => {
        const visibleItems = Array.from(albumItems).filter(item =>
          (item as HTMLElement).style.display !== 'none',
        )

        visibleItems.forEach((item, index) => {
          const divider = (item as HTMLElement).querySelector('.album-divider') as HTMLElement
          if (divider) {
            if (index === visibleItems.length - 1) {
              divider.style.display = 'none'
            }
            else {
              divider.style.display = 'block'
            }
          }
        })
      }, 10)
    })
  })
})
</script>
</div>

<style>
  .works-gallery {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  /* 分类标签样式 */
  .category-tags {
    margin-bottom: 3rem;
    text-align: center;
  }

  .category-tag {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 0.6rem 1.8rem;
    background: transparent;
    color: var(--text-color);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 0.3rem;
    min-height: 2.5rem;
  }

  .category-tag:hover {
    border-color: #000;
  }

  .category-tag.active {
    border-color: #000;
  }

  /* 相册列表样式 */
  .album-list {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .album-item {
    width: 100%;
  }

  .album-link {
    text-decoration: none;
    color: inherit;
    display: block;
    padding: 2rem 0;
    transition: background-color 0.3s ease;
  }

  .album-link:hover {
    background-color: var(--bg-secondary);
  }

  .album-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 2rem;
    max-width: 100%;
  }

  .album-info {
    flex: 1;
    min-width: 0;
  }

  .album-title {
    margin: 0 0 0.8rem 0;
    font-size: 1.4rem;
    font-weight: 600;
    line-height: 1.3;
    color: var(--text-color);
  }

  .album-description {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    line-height: 1.5;
    color: var(--text-secondary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .album-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.9rem;
    color: var(--text-tertiary);
  }

  .album-date {
    font-weight: 500;
  }

  .album-category {
    background: transparent;
    border: 1px solid #d1d5db;
    padding: 0.4rem 1rem;
    border-radius: 8px;
    font-size: 0.8rem;
    color: var(--text-secondary);
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 1.8rem;
  }

  .album-meta:hover .album-category {
    border-color: #000;
  }

  .album-thumbnail {
    flex-shrink: 0;
    width: 200px;
    height: 120px;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
  }

  .thumbnail-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: grayscale(100%);
    transition: all 0.4s ease;
  }

  .album-link:hover .thumbnail-image {
    filter: grayscale(0%);
    transform: scale(1.05);
  }

  .thumbnail-placeholder {
    width: 100%;
    height: 100%;
    background: var(--bg-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
  }

  .placeholder-text {
    font-size: 0.9rem;
    opacity: 0.7;
  }

  .album-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, var(--border-color) 20%, var(--border-color) 80%, transparent 100%);
    opacity: 0.4;
    margin: 0;
    position: relative;
  }

  .album-divider::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 1px;
    background: var(--primary-color);
    opacity: 0.6;
  }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .works-gallery {
      padding: 1rem 0.5rem;
    }

    .album-content {
      flex-direction: column-reverse;
      gap: 1rem;
      text-align: center;
    }

    .album-thumbnail {
      width: 100%;
      max-width: 300px;
      height: 180px;
    }

    .album-meta {
      justify-content: center;
    }

    .category-tags {
      margin-bottom: 2rem;
    }
  }

  @media (max-width: 480px) {
    .album-title {
      font-size: 1.2rem;
    }

    .album-description {
      font-size: 0.9rem;
    }

    .album-thumbnail {
      height: 150px;
    }
  }
</style>
